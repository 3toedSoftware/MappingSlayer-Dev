<!doctype html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta
            name="viewport"
            content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"
        />
        <title>Mapping Slayer - Professional Sign Mapping Platform</title>

        <!-- AI Interface Detection -->
        <meta name="ai-interface" content="sidekick" />
        <meta name="ai-interface-version" content="1.0" />
        <meta name="ai-documentation" content="../../docs/SIDEKICK_AI_GUIDE.md" />
        <link rel="stylesheet" href="../styles/mapping-slayer.css" />
        <link
            rel="stylesheet"
            href="https://cdn.jsdelivr.net/npm/@simonwep/pickr/dist/themes/classic.min.css"
        />

        <!-- External libraries -->
        <script src="https://cdn.jsdelivr.net/npm/@simonwep/pickr/dist/pickr.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/pako/2.1.0/pako.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
        <!-- svg2pdf for vector SVG support in jsPDF -->
        <script src="https://cdn.jsdelivr.net/npm/svg2pdf.js@2.2.3/dist/svg2pdf.umd.min.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/tesseract.js@4/dist/tesseract.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
        <!-- LibLouis for proper Grade 2 Braille translation -->
        <script src="../../sign-template-maker/lib/liblouis/easy-api.js"></script>
        <script src="../../sign-template-maker/lib/liblouis/build-no-tables-utf16.js"></script>
        <!-- Fallback Grade 2 if LibLouis fails -->
        <script src="../../braille-grade2.js"></script>
    </head>
    <body>
        <div id="app-container"></div>

        <script type="module">
            /**
             * Dynamically loads a script and returns a promise
             */
            function loadScript(url) {
                return new Promise((resolve, reject) => {
                    const script = document.createElement('script');
                    script.src = url;
                    script.onload = () => resolve();
                    script.onerror = () => reject(new Error(`Failed to load script: ${url}`));
                    document.head.appendChild(script);
                });
            }

            /**
             * Creates the main suite structure with permanent header
             */
            function createSuiteStructure() {
                return `
                <div class="slayer-app-container">
                    <!-- Unified Header (always visible) -->
                    <div class="slayer-header">
                        <!-- Logo Section -->
                        <div class="logo-section">
                            <img src="../assets/MSLogo.svg" alt="Mapping Slayer" class="mapping-logo" style="height: 30px; width: auto;" onerror="this.style.display='none'; document.getElementById('logo-text').style.display='inline';">
                            <span id="logo-text" style="display: none;" class="mapping-logo">MAPPING SLAYER</span>
                        </div>

                        <!-- App Navigation -->
                        <div class="app-navigation">
                            <!-- App navigation area -->
                        </div>

                        <!-- Project Info -->
                        <div class="project-info">
                            <div class="project-name" id="project-name-display">No project loaded</div>
                        </div>

                        <!-- Header Controls -->
                        <div class="header-controls">
                            <button type="button" class="btn btn-secondary" id="load-project-btn">LOAD</button>
                            <button type="button" class="btn btn-primary" id="save-project-btn">SAVE</button>
                            <button type="button" class="btn btn-primary" id="save-as-project-btn">SAVE AS</button>
                        </div>
                    </div>

                    <!-- Content Area -->
                    <div class="app-content" id="app-content"></div>
                </div>
            `;
            }

            /**
             * Main Mapping Slayer initializer
             */
            async function initializeMappingSlayer() {
                try {
                    // Load debug configuration first
                    await loadScript('../core/debug-config.js');

                    // Load PDF.js
                    if (window.debugLog) {
                        window.debugLog('VERBOSE', 'Loading PDF.js library...');
                    }
                    try {
                        await loadScript(
                            'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js'
                        );
                        if (window.pdfjsLib) {
                            pdfjsLib.GlobalWorkerOptions.workerSrc =
                                'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
                            if (window.debugLog) {
                                window.debugLog('VERBOSE', 'PDF.js configured successfully.');
                            }
                        }
                    } catch (pdfError) {
                        console.warn(
                            'PDF.js failed to load, continuing without PDF support:',
                            pdfError
                        );
                    }

                    // Load Braille font
                    try {
                        const response = await fetch('../../BRAILLE.TTF');
                        const blob = await response.blob();
                        const reader = new FileReader();

                        await new Promise((resolve, reject) => {
                            reader.onload = function (event) {
                                const base64 = event.target.result;
                                const style = document.createElement('style');
                                style.id = 'braille-font-style';
                                style.textContent = `
                                    @font-face {
                                        font-family: 'Braille';
                                        src: url(${base64}) format('truetype');
                                        font-weight: normal;
                                        font-style: normal;
                                    }
                                `;
                                document.head.appendChild(style);
                                console.log('Braille font loaded successfully');
                                resolve();
                            };
                            reader.onerror = reject;
                            reader.readAsDataURL(blob);
                        });
                    } catch (brailleError) {
                        console.warn('Braille font failed to load:', brailleError);
                    }

                    // Initialize LibLouis for proper Grade 2 braille
                    console.log('=== LIBLOUIS INITIALIZATION DEBUG ===');
                    try {
                        console.log('Waiting 100ms for LibLouis scripts to load...');
                        // Wait a bit for LibLouis to load
                        await new Promise(resolve => setTimeout(resolve, 100));

                        console.log('Checking for LibLouis components:');
                        console.log('- LiblouisEasyApi:', typeof LiblouisEasyApi);
                        console.log('- liblouisBuild:', typeof liblouisBuild);
                        console.log('- Module:', typeof Module);

                        let lou = null;

                        // Check if LiblouisEasyApi is available
                        if (typeof LiblouisEasyApi !== 'undefined') {
                            console.log('Found LiblouisEasyApi, initializing...');
                            // Check for liblouisBuild first
                            if (typeof liblouisBuild !== 'undefined') {
                                console.log('Found liblouisBuild, using it for initialization');
                                lou = new LiblouisEasyApi(liblouisBuild);
                            } else {
                                // Try without argument to use default
                                console.log('Trying LiblouisEasyApi with auto-detection');
                                lou = new LiblouisEasyApi();
                            }
                        } else {
                            console.error(
                                'LiblouisEasyApi NOT FOUND - LibLouis scripts may not have loaded'
                            );
                        }

                        if (lou) {
                            console.log('LibLouis object created, setting up table loading...');

                            try {
                                // Load all necessary table files including ALL dependencies
                                const tablesToLoad = [
                                    'unicode.dis', // Required for Unicode braille output
                                    'loweredDigits6Dots.uti', // Required by chardefs.cti
                                    'latinLetterDef8Dots.uti', // Required by chardefs.cti
                                    'latinLetterDef6Dots.uti', // Alternative letter definitions
                                    'chardefs.cti', // Character definitions (loads after its dependencies)
                                    'braille-patterns.cti', // Braille pattern definitions
                                    'litdigits6Dots.uti', // Literal digits for 6-dot braille
                                    'digits6Dots.uti', // Standard digits
                                    'en-us-g1.ctb', // Grade 1 US English (included by g2)
                                    'en-us-g2.ctb' // Grade 2 US English (main table)
                                ];

                                const tableContents = {};

                                // Load all table files
                                for (const tableName of tablesToLoad) {
                                    const response = await fetch(
                                        `../../sign-template-maker/lib/liblouis/tables/${tableName}`
                                    );
                                    if (response.ok) {
                                        tableContents[tableName] = await response.text();
                                        console.log(
                                            `Loaded table ${tableName}, size: ${tableContents[tableName].length}`
                                        );
                                    } else {
                                        console.error(`Failed to load table ${tableName}`);
                                    }
                                }

                                // Set up the virtual filesystem
                                const FS = lou.getFilesystem();
                                if (FS) {
                                    // Create tables directory in virtual filesystem root
                                    try {
                                        FS.mkdir('/tables');
                                    } catch (e) {
                                        // Directory might already exist
                                    }

                                    // Write all tables to virtual filesystem
                                    for (const [name, content] of Object.entries(tableContents)) {
                                        FS.writeFile(`/tables/${name}`, content);
                                        console.log(
                                            `Wrote ${name} to virtual filesystem at /tables/${name}`
                                        );
                                    }

                                    // Set the data path for LibLouis to root
                                    lou.setDataPath('/');
                                    console.log('LibLouis data path set to /');

                                    // Test if it works
                                    try {
                                        console.log('Testing LibLouis with simple text...');
                                        const tableList = 'tables/unicode.dis,tables/en-us-g2.ctb';
                                        const testResult = lou.translateString(tableList, 'test');
                                        console.log(
                                            'LibLouis test successful! Result:',
                                            testResult
                                        );

                                        // Store the table list for use in translation
                                        window.liblouisTableList = tableList;
                                        console.log(
                                            'Table list stored for translation:',
                                            tableList
                                        );
                                    } catch (testError) {
                                        console.error('LibLouis test failed:', testError);
                                    }

                                    // Make it globally available
                                    window.lou = lou;
                                    window.translator = lou;
                                    console.log('LibLouis set as window.lou and window.translator');
                                    console.log(
                                        'LibLouis Grade 2 translator initialized successfully!'
                                    );
                                } else {
                                    console.error('Could not get LibLouis filesystem');
                                }
                            } catch (tableLoadError) {
                                console.error('Error loading tables:', tableLoadError);
                            }
                        } else {
                            console.error('LibLouis object could not be created');
                        }
                    } catch (liblouisError) {
                        console.error('Error initializing LibLouis:', liblouisError);
                        console.error('Error stack:', liblouisError.stack);
                    }
                    console.log('=== END LIBLOUIS INITIALIZATION ===');

                    // Import core framework
                    const { initializeCore, appBridge, saveManager } = await import(
                        '../core/index.js'
                    );

                    // Import Mapping Slayer app
                    const MappingSlayerApp = (await import('./mapping-app.js')).default;

                    // Initialize core
                    initializeCore(true);

                    // Expose appBridge to window for communication
                    window.appBridge = appBridge;

                    // Get main container and create suite structure
                    const mainContainer = document.getElementById('app-container');
                    mainContainer.innerHTML = createSuiteStructure();

                    // Get the content area where app will render
                    const contentArea = document.getElementById('app-content');

                    // Create container for Mapping Slayer
                    const appContainer = document.createElement('div');
                    appContainer.id = 'mapping_slayer-container';
                    appContainer.style.width = '100%';
                    appContainer.style.height = '100%';
                    contentArea.appendChild(appContainer);

                    // Initialize Mapping Slayer
                    const mappingApp = new MappingSlayerApp();
                    await mappingApp.initialize(appContainer, true);

                    // Initialize the save manager
                    await saveManager.initialize();

                    // Make saveManager globally available
                    window.saveManager = saveManager;
                    if (window.debugLog) {
                        window.debugLog('VERBOSE', 'ðŸ“Š [Main] SaveManager made globally available');
                    }

                    // Activate Mapping Slayer
                    await appBridge.switchToApp('mapping_slayer');

                    if (window.logAlways) {
                        window.logAlways('Mapping Slayer initialized successfully!');
                        window.logAlways('Ready to map!');
                    }

                    // Load Sidekick AI interface
                    const sidekickScript = document.createElement('script');
                    sidekickScript.src = './ai-interface.js';
                    sidekickScript.onload = () => console.log('ðŸ¤– Sidekick AI interface loaded');
                    document.body.appendChild(sidekickScript);

                    // Load Sign Template System
                    const templateScript = document.createElement('script');
                    templateScript.type = 'module';
                    templateScript.src = './sign-template-system.js';
                    templateScript.onload = () => console.log('ðŸŽ¨ Sign Template System loaded');
                    document.body.appendChild(templateScript);
                } catch (error) {
                    console.error('Failed to initialize Mapping Slayer:', error);
                    const container = document.getElementById('app-container');
                    container.innerHTML = `
                    <div style="padding: 40px; text-align: center; color: #ff6b6b;">
                        <h2>Initialization Error</h2>
                        <p>Failed to load Mapping Slayer. Please check the console for details.</p>
                        <p>${error.message}</p>
                    </div>
                `;
                }
            }

            // Start the application
            initializeMappingSlayer();
        </script>
    </body>
</html>
