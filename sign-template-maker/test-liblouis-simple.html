<!doctype html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Simple LibLouis Test</title>
        <style>
            @font-face {
                font-family: 'Braille';
                src: url('BRAILLE.TTF') format('truetype');
            }
            body {
                font-family: Arial, sans-serif;
                max-width: 800px;
                margin: 40px auto;
                padding: 20px;
            }
            .braille {
                font-family: 'Braille', monospace;
                font-size: 36px;
                background: white;
                padding: 15px;
                margin: 10px 0;
                border: 2px solid #003875;
                border-radius: 4px;
            }
            .test-row {
                display: grid;
                grid-template-columns: 150px 200px 200px;
                gap: 20px;
                margin: 10px 0;
                padding: 10px;
                background: #f5f5f5;
                border-radius: 4px;
            }
            .status {
                padding: 10px;
                margin: 10px 0;
                border-radius: 4px;
            }
            .success {
                background: #d4edda;
                color: #155724;
            }
            .error {
                background: #f8d7da;
                color: #721c24;
            }
            .warning {
                background: #fff3cd;
                color: #856404;
            }
        </style>
    </head>
    <body>
        <h1>Simple LibLouis Grade 2 Test</h1>

        <div id="status" class="status warning">Initializing LibLouis...</div>

        <div id="tests"></div>

        <!-- Load LibLouis -->
        <script src="lib/build-no-tables-utf16.js"></script>

        <script>
            let liblouis = null;
            const tableCache = {};

            // Wait for LibLouis to be available
            function waitForLibLouis() {
                return new Promise(resolve => {
                    const check = () => {
                        if (typeof Module !== 'undefined' && Module.ccall) {
                            console.log('LibLouis WASM module ready');
                            resolve();
                        } else {
                            setTimeout(check, 100);
                        }
                    };
                    check();
                });
            }

            async function loadAllTables() {
                const tables = [
                    'en-us-g2.ctb',
                    'en-us-g1.ctb',
                    'chardefs.cti',
                    'litdigits6Dots.uti',
                    'braille-patterns.cti',
                    'loweredDigits6Dots.uti',
                    'latinLetterDef8Dots.uti',
                    'spaces.ctb',
                    'unicode.dis',
                    'latinLetterDef6Dots.uti',
                    'digits6Dots.uti',
                    'digits8Dots.uti',
                    'loweredDigits8Dots.uti'
                ];

                for (const table of tables) {
                    try {
                        const response = await fetch('lib/tables/' + table);
                        if (response.ok) {
                            tableCache[table] = await response.text();
                            console.log('Loaded:', table);
                        }
                    } catch (e) {
                        console.warn('Could not load:', table);
                    }
                }
            }

            async function initLibLouis() {
                const statusDiv = document.getElementById('status');

                try {
                    // Wait for WASM module
                    await waitForLibLouis();

                    // Load all table files
                    await loadAllTables();

                    // Create LibLouis instance with direct Module access
                    if (typeof Module !== 'undefined' && Module.FS) {
                        console.log('Using direct Module interface');

                        // Create virtual filesystem directories
                        try {
                            Module.FS.mkdir('/tables');
                        } catch (e) {
                            // Directory might already exist
                        }

                        // Write all tables to virtual filesystem
                        for (const [name, content] of Object.entries(tableCache)) {
                            Module.FS.writeFile('/tables/' + name, content);
                            console.log('Wrote to FS:', '/tables/' + name);
                        }

                        // Create wrapper for translation
                        liblouis = {
                            translateString: function (table, text) {
                                // Use Module.ccall to call LibLouis translate function
                                const tablePtr = Module.allocate(
                                    Module.intArrayFromString('/tables/' + table),
                                    'i8',
                                    Module.ALLOC_NORMAL
                                );
                                const inputPtr = Module.allocate(
                                    Module.intArrayFromString(text),
                                    'i8',
                                    Module.ALLOC_NORMAL
                                );
                                const outputPtr = Module._malloc(text.length * 4 * 2); // Allocate space for output

                                try {
                                    // Call lou_translateString
                                    const result = Module.ccall(
                                        'lou_translateString',
                                        'number',
                                        [
                                            'number',
                                            'number',
                                            'number',
                                            'number',
                                            'number',
                                            'number',
                                            'number',
                                            'number'
                                        ],
                                        [
                                            tablePtr,
                                            inputPtr,
                                            text.length,
                                            outputPtr,
                                            text.length * 4,
                                            0,
                                            0,
                                            0
                                        ]
                                    );

                                    if (result) {
                                        // Read output as UTF-16 and convert to string
                                        const output = [];
                                        for (let i = 0; i < text.length * 2; i++) {
                                            const char = Module.getValue(outputPtr + i * 2, 'i16');
                                            if (char === 0) break;
                                            output.push(String.fromCharCode(char));
                                        }
                                        return output.join('');
                                    }
                                } catch (e) {
                                    console.error('Translation error:', e);
                                } finally {
                                    Module._free(tablePtr);
                                    Module._free(inputPtr);
                                    Module._free(outputPtr);
                                }

                                // Fallback to simple replacement
                                return text;
                            }
                        };

                        statusDiv.className = 'status success';
                        statusDiv.textContent = 'LibLouis initialized with direct Module interface';
                    } else {
                        throw new Error('Module not available');
                    }

                    // Run tests
                    runTests();
                } catch (error) {
                    console.error('Init error:', error);
                    statusDiv.className = 'status error';
                    statusDiv.textContent = 'Failed to initialize: ' + error.message;
                }
            }

            function runTests() {
                const testsDiv = document.getElementById('tests');

                const testCases = [
                    { input: 'and', expected: '&', desc: 'Simple contraction' },
                    { input: 'the', expected: '!', desc: 'Common word' },
                    { input: 'for', expected: '=', desc: 'Common word' },
                    { input: 'of', expected: '(', desc: 'Common word' },
                    { input: 'with', expected: ')', desc: 'Common word' },
                    { input: 'STORAGE', expected: null, desc: 'Should use contractions' },
                    { input: 'EMPLOYEES ONLY', expected: null, desc: 'Multiple words' }
                ];

                let html = '<h2>Test Results</h2>';

                for (const test of testCases) {
                    let result = '';
                    let status = '';

                    try {
                        if (liblouis && liblouis.translateString) {
                            result = liblouis.translateString('en-us-g2.ctb', test.input);
                        } else {
                            result = 'No translator';
                            status = 'error';
                        }

                        // Check if contracted (shorter than input)
                        if (result.length < test.input.length) {
                            status = 'success';
                        } else if (result === test.input) {
                            status = 'warning';
                        }
                    } catch (e) {
                        result = 'Error: ' + e.message;
                        status = 'error';
                    }

                    html += `
                    <div class="test-row">
                        <div><strong>${test.input}</strong></div>
                        <div class="braille">${result}</div>
                        <div class="${status}">
                            ${test.desc}<br>
                            ${test.input.length} â†’ ${result.length} chars
                        </div>
                    </div>
                `;
                }

                testsDiv.innerHTML = html;
            }

            // Initialize when page loads
            window.addEventListener('DOMContentLoaded', () => {
                setTimeout(initLibLouis, 500);
            });
        </script>
    </body>
</html>
